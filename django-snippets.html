<!DOCTYPE html>
<html lang="en">

    <!-- head -->
    <head>
        <meta charset="utf-8" />
        <meta name="author" content="Kirill Klenov" />
        <meta name="keywords" content="python,django,cache,upload,orm," />
        <meta name="description" content="Несколько полезных сниппетов для джанго" />

        <meta name="application-name" content="klen.github.io" />
        <meta name="application-url" content="." />

    <meta name="og:image" content="http://klen.github.io/theme/images/logo.png" />
    <meta name="og:title" content="Несколько полезных сниппетов для джанго" />

        <title>Несколько полезных сниппетов для джанго — klen.github.io</title>

        <link href="/theme/build_main.css" rel="stylesheet" type="text/css" media="screen" />

<link rel="alternate" type="application/atom+xml" title="klen.github.io - all posts" href="http://feeds.feedburner.com/klengihubcom"> 

<link rel="openid.server" href="http://www.myopenid.com/server"> 
            <link rel="openid.delegate" href="http://horneds.myopenid.com/"> 
            <link rel="openid2.local_id" href="http://horneds.myopenid.com/"> 
            <link rel="openid2.provider" href="http://www.myopenid.com/server"> 
            <meta http-equiv="X-XRDS-Location" content="http://www.myopenid.com/xrds?username=horneds.myopenid.com">    </head>

    <body class="cloud zeta">
        <h1 class="header">
            <a class="header_title" href=.><i class="fa fa-beer"></i>klen.github.io</a>
        </h1>

        <nav class="menu">            <a class="menu_item menu_link" href="./pages/about-en.html">About me</a>            <a class="menu_item menu_link" href="./category/blog.html">Blog</a>            <a class="menu_item menu_link" href="./category/notes.html">Notes</a>        </nav>

        <div class="content">

<article class="article">

        <header class="article_header">
            <time class="article_header_time" datetime="2011-12-02 00:00:00">02.12.2011</time>
            <span>in <a href="./category/Blog.html">Blog</a></span>
            <h1 class="article_header_title">Несколько полезных сниппетов для джанго</h1><span class="article_meta">tags: <span><a href="./tag/python.html">python</a> , </span> <span><a href="./tag/django.html">django</a> , </span> <span><a href="./tag/cache.html">cache</a> , </span> <span><a href="./tag/upload.html">upload</a> , </span> <span><a href="./tag/orm.html">orm</a> </span> </span></header>

<div class="article_paginator zeta">        <div class="article_paginator_right">
            <a href="https-setup.html" class="article_paginator_right_link">Настройка HTTPS для чайников</a> Ctrl→
        </div>        <div class="article_paginator_left">
            ←Ctrl <a href="deploy-setup.html" class="article_paginator_left_link">Настройка сервера. Создаем и разворачиваем django-проект</a>
        </div></div>

        <div class="article_content">
            <hr class="docutils" />
<div class="contents topic" id="id2">
<p class="topic-title first">Содержание:</p>
<ul class="simple">
<li><a class="reference internal" href="#filefield-imagefield" id="id9">Автоматическая генерация имени файла в полях типа FileField, ImageField</a><ul>
<li><a class="reference internal" href="#id3" id="id10">Пример работы</a></li>
<li><a class="reference internal" href="#id4" id="id11">Параметры сниппета</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5" id="id12">Работа с кешем</a><ul>
<li><a class="reference internal" href="#id6" id="id13">Примеры работы</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id7" id="id14">Атомарные обновления</a></li>
</ul>
</div>
<hr class="docutils" />
<p>Ниже находится несколько полезных <a class="reference external" href="http://djangoproject.com/">Django</a> сниппетов, которые я использую в своей работе.</p>
<div class="section" id="filefield-imagefield">
<h2><a class="toc-backref" href="#id9">Автоматическая генерация имени файла в полях типа FileField, ImageField</a></h2>
<p>В <a class="reference external" href="http://djangoproject.com/">Django</a> поля типа <a class="reference external" href="https://docs.djangoproject.com/en/dev/ref/models/fields/#filefield">FileField</a> и <a class="reference external" href="https://docs.djangoproject.com/en/dev/ref/models/fields/#imagefield">ImageField</a> позволяют определять функцию для генерации имени
сохраняемого файла. Она указывается в аргументе <tt class="docutils literal">upload_to</tt> при создании поля.</p>
<p>Когда мне надоело придумывать уникальные имена файлов, при сохранении их
в <a class="reference external" href="http://djangoproject.com/">Django</a>-проектах я написал нижеприведенный сниппет.</p>
<ul class="simple">
<li>Генерируемые пути файлов содержат только латинские и цифровые символы;</li>
<li>Файлы с одинаковыми названиями, загружаемые в разные инстансы не перезаписываются;</li>
<li>Файлы удобно хранятся отсортированные по приложениям и моделям;</li>
<li>Путь файла однозначно говорит нам о том, что за инстанс его использует;</li>
<li>Система не позволяет тысячам файлов скапливаться в одной папке;</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">md5</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span> <span class="k">as</span> <span class="n">op</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>


<span class="k">def</span> <span class="nf">upload_to</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Auto generate name for File and Image fields.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">pk</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="k">if</span> <span class="n">unique</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># We think that we use utf8 based OS file system</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">+</span> <span class="n">ext</span>
    <span class="n">basedir</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">module_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
        <span class="n">basedir</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">filename</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">filename</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id10">Пример работы</a></h3>
<p>Например у нас есть модель <tt class="docutils literal">Archive</tt> в приложении <tt class="docutils literal">storage</tt>, <cite>storage/models.py</cite>:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Archive</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FileField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="n">upload_to</span><span class="p">)</span>
</pre></div>
<p>В результате сохраненные файлы будут иметь пути вида:
<cite>{MEDIA_URL}/storage/archive/21/40/2140e8fe8678bc08ff6e9b10c9639068.zip</cite></p>
<p>Здесь присутствует имя приложения, имя модели, созданное новое имя файла и его расширение.
При этом путь дробится на папки согласно четырем первым символам в имени файла <cite>21/40/2140e8...</cite>.
Это позволяет значительно отсрочить ситуацию с сотнями тысяч объектов в папке и тормоза файловой системы.</p>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id11">Параметры сниппета</a></h3>
<p>Функция <cite>upload_to</cite> может принимать до 4-х параметров. Аргументы <strong>instance</strong> и <strong>filename</strong> передаются <a class="reference external" href="http://djangoproject.com/">Django</a>.</p>
<p>Аргумент <strong>prefix</strong> принимает строковые значения и позволяет дополнительно настраивать пути файлов.
Например при определении префикса <cite>prefix=&quot;cart&quot;</cite> вышеприведенный код будет сохранять файлы с путями вида:
<cite>{MEDIA_URL}/storage/archive/cart/21/40/2140e8fe8678bc08ff6e9b10c9639068.zip</cite>. Префикс был добавлен после имени модели.</p>
<p>Аргумент <strong>unique</strong> принимает булевы значения и позволяет гарантированно получить уникальное имя файла. По-умолчанию для <cite>instance</cite>
с одинаковым ключом, для одинаковых имен файла, будет создан идентичный путь. Это сделано намеренно, чтобы при обновлении
файлов пути в конкретной модели не изменялись. Параметр <cite>unique</cite> меняет это поведение и при каждом изменении файла, путь будет другим.</p>
<p>Но как использовать все эти параметры если <a class="reference external" href="http://djangoproject.com/">Django</a> передает в указанную функцию только первые два? Здесь нам поможет <a class="reference external" href="http://ru.wikipedia.org/wiki/%D0%9A%D0%B0%D1%80%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5">Каррирование</a>.
Мы используем функцию <strong>curry</strong> из <cite>django.utils.functional</cite>, которая имитирует это поведение в python.</p>
<p>Например в нижеприведенном коде:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.utils.functional</span> <span class="kn">import</span> <span class="n">curry</span>

<span class="k">class</span> <span class="nc">Archive</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">cover</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="n">curry</span><span class="p">(</span><span class="n">upload_to</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;cover&#39;</span><span class="p">))</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FileField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="n">curry</span><span class="p">(</span><span class="n">upload_to</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">))</span>
    <span class="n">other</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FileField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="n">curry</span><span class="p">(</span><span class="n">upload_to</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
</pre></div>
<p>Файлы из поля <cite>cover</cite> будут сохраняться с путями вида: <cite>{MEDIA_URL}/storage/archive/cover/21/40/2140e8fe8678bc08ff6e9b10c9639068.jpg</cite></p>
<p>Файлы из поля <cite>file</cite> будут сохраняться с путями вида: <cite>{MEDIA_URL}/storage/archive/file/21/40/2140e8fe8678bc08ff6e9b10c9639068.zip</cite></p>
<p>Файлы из поля <cite>other</cite> всегда будут иметь уникальные пути, вида: <cite>{MEDIA_URL}/storage/archive/11/11/1111e8fe8678bc08ff6e9b10c9639068.mp3</cite></p>
</div>
</div>
<div class="section" id="id5">
<h2><a class="toc-backref" href="#id12">Работа с кешем</a></h2>
<p>В работе с кешированием проекта нужна четкая стратегия и обозначенные соглашения.
Например наименования ключей кэша. <cite>SomeModel.object.filter(active=True)</cite> с каким ключом хранить
результат выполнения этого запроса? Как параллельный разработчик узнает этот ключ? Когда производить
инвалидацию? Для <a class="reference external" href="http://djangoproject.com/">Django</a> существуют приложения помогающие решать эту проблему, но зачастую они слишком
перегружены и сложны в использовании.</p>
<p>Для простых проектов я написал несколько полезных функций:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">django.core.cache</span> <span class="kn">import</span> <span class="n">cache</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">get_model</span>
<span class="kn">from</span> <span class="nn">django.db.models.base</span> <span class="kn">import</span> <span class="n">ModelBase</span>
<span class="kn">from</span> <span class="nn">django.db.models.query</span> <span class="kn">import</span> <span class="n">QuerySet</span>
<span class="kn">from</span> <span class="nn">django.utils.encoding</span> <span class="kn">import</span> <span class="n">smart_str</span>

<span class="k">def</span> <span class="nf">cached_instance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">filters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Auto cached model instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="k">assert</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;&#39;model_class&#39; must be either a model&quot;</span>
                                <span class="s2">&quot; or a model name in the format&quot;</span>
                                <span class="s2">&quot; app_label.model_name&quot;</span><span class="p">)</span>
        <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>

    <span class="n">cache_key</span> <span class="o">=</span> <span class="n">generate_cache_key</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">filters</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">get_cached</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">cached_query</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Auto cached queryset and generate results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cache_key</span> <span class="o">=</span> <span class="n">generate_cache_key</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">get_cached</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">qs</span><span class="p">,),</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">clean_cache</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Generate cache key and clean cached value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cache_key</span> <span class="o">=</span> <span class="n">generate_cache_key</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">generate_cache_key</span><span class="p">(</span><span class="n">cached</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Auto generate cache key for model or queryset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cached</span><span class="p">,</span> <span class="n">QuerySet</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cached</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cached</span><span class="p">,</span> <span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">ModelBase</span><span class="p">)):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cached</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
                <span class="n">cached</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">module_name</span><span class="p">,</span>
                <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Objects must be queryset or model.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Cache key cannot be empty.&#39;</span><span class="p">)</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">clean_cache_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">key</span>


<span class="k">def</span> <span class="nf">clean_cache_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Replace spaces with &#39;-&#39; and hash if length is greater than 250.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cache_key</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">r&#39;\s+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="n">cache_key</span> <span class="o">=</span> <span class="n">smart_str</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="n">cache_key</span><span class="p">[:</span><span class="mi">150</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">cache_key</span>


<span class="k">def</span> <span class="nf">get_cached</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">default_timeout</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>

    <span class="c1">#**</span>
</pre></div>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id13">Примеры работы</a></h3>
<div class="highlight"><pre><span></span><span class="c1"># Генерация ключей для Queryset (разные ключи для разных запросов)</span>
<span class="k">print</span> <span class="n">generate_cache_key</span><span class="p">(</span><span class="n">TaxiStation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="k">print</span> <span class="n">generate_cache_key</span><span class="p">(</span><span class="n">TaxiStation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="k">print</span> <span class="n">generate_cache_key</span><span class="p">(</span><span class="n">TaxiStation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
<span class="k">print</span> <span class="n">generate_cache_key</span><span class="p">(</span><span class="n">TaxiStation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">city</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;intaxi&quot;</span><span class="p">))</span>
<span class="k">print</span> <span class="n">generate_cache_key</span><span class="p">(</span><span class="n">TaxiStation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

<span class="c1"># Output: &#39;SELECT-&quot;main_taxistation&quot;.&quot;id&quot;,-&quot;main_taxistation&quot;.&quot;active&quot;,-&quot;main_taxistation&quot;.&quot;title&quot;,-&quot;main_taxistation&quot;.&quot;city_id&quot;,-&quot;main_taxistation&quot;.&quot;agent_id&quot;,--873aa3b2fbd81cdaa9fce75e60706579&#39;</span>
<span class="c1"># Output: &#39;SELECT-&quot;main_taxistation&quot;.&quot;id&quot;,-&quot;main_taxistation&quot;.&quot;active&quot;,-&quot;main_taxistation&quot;.&quot;title&quot;,-&quot;main_taxistation&quot;.&quot;city_id&quot;,-&quot;main_taxistation&quot;.&quot;agent_id&quot;,--873aa3b2fbd81cdaa9fce75e60706579&#39;</span>
<span class="c1"># Output: &#39;SELECT-&quot;main_taxistation&quot;.&quot;id&quot;,-&quot;main_taxistation&quot;.&quot;active&quot;,-&quot;main_taxistation&quot;.&quot;title&quot;,-&quot;main_taxistation&quot;.&quot;city_id&quot;,-&quot;main_taxistation&quot;.&quot;agent_id&quot;,--043271300c8db6cc9152ef3119e6195c&#39;</span>
<span class="c1"># Output: &#39;SELECT-&quot;main_taxistation&quot;.&quot;id&quot;,-&quot;main_taxistation&quot;.&quot;active&quot;,-&quot;main_taxistation&quot;.&quot;title&quot;,-&quot;main_taxistation&quot;.&quot;city_id&quot;,-&quot;main_taxistation&quot;.&quot;agent_id&quot;,--98960ebe77c30e08fe6b4a4fd2b1ab57&#39;</span>
<span class="c1"># Output: &#39;SELECT-&quot;main_taxistation&quot;.&quot;id&quot;,-&quot;main_taxistation&quot;.&quot;active&quot;,-&quot;main_taxistation&quot;.&quot;title&quot;,-&quot;main_taxistation&quot;.&quot;city_id&quot;,-&quot;main_taxistation&quot;.&quot;agent_id&quot;,--043271300c8db6cc9152ef3119e6195c&#39;</span>

<span class="c1"># Генерация ключей для Model</span>
<span class="k">print</span> <span class="n">generate_cache_key</span><span class="p">(</span><span class="n">TaxiStation</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">print</span> <span class="n">generate_cache_key</span><span class="p">(</span><span class="n">TaxiStation</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="c1"># Output: main.taxistation:pk=50</span>

<span class="c1"># Кеширование Queryset (получение данных из кеша или из БД с сохранением в кеш)</span>
<span class="nb">all</span> <span class="o">=</span> <span class="n">cached_query</span><span class="p">(</span><span class="n">SomeModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="n">some_results</span> <span class="o">=</span>  <span class="n">cached_query</span><span class="p">(</span><span class="n">SomeModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">param</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

<span class="c1"># Принудительная очистка кеша Queryset</span>
<span class="n">clean_cache</span><span class="p">(</span><span class="n">SomeModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="n">clean_cache</span><span class="p">(</span><span class="n">SomeModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">param</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

<span class="c1"># Кеширование instance</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">cached_instance</span><span class="p">(</span><span class="n">Order</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Some title&quot;</span><span class="p">)</span>

<span class="c1"># можно и по имени</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">cached_instance</span><span class="p">(</span><span class="s1">&#39;app.order&#39;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Some title&quot;</span><span class="p">)</span>

<span class="c1"># Очистка кеша</span>
<span class="n">clean_cache</span><span class="p">(</span><span class="n">Order</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Some title&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h2><a class="toc-backref" href="#id14">Атомарные обновления</a></h2>
<p>Часто возникают ситуации когда нам необходимо обновить одно или несколько полей объекта.
В <a class="reference external" href="http://djangoproject.com/">Django</a> по-умолчанию это можно сделать при помощи следующего кода:</p>
<div class="highlight"><pre><span></span><span class="c1"># Допустим у нас есть объект order (instance of model)</span>
<span class="n">order</span><span class="o">.</span><span class="n">custom_field</span> <span class="o">=</span> <span class="n">custom_value</span>
<span class="n">order</span><span class="o">.</span><span class="n">full_clean</span><span class="p">()</span>
<span class="n">order</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
<p>При этом ORM <a class="reference external" href="http://djangoproject.com/">Django</a> создает и выполняет запрос содержащий обновление <strong>всех полей</strong> объекта, что может быть довольно медленной операцией.</p>
<p>Значительно быстрее сработает следующая конструкция:</p>
<div class="highlight"><pre><span></span><span class="n">order</span><span class="o">.</span><span class="n">custom_field</span> <span class="o">=</span> <span class="n">custom_value</span>
<span class="n">order</span><span class="o">.</span><span class="n">full_clean</span><span class="p">()</span>
<span class="n">Order</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">custom_field</span> <span class="o">=</span> <span class="n">custom_value</span><span class="p">)</span>
</pre></div>
<p>Но она несколько неудобна. Следующая функция решает эту проблему.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">operator</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.db.models.expressions</span> <span class="kn">import</span> <span class="n">F</span><span class="p">,</span> <span class="n">ExpressionNode</span>


<span class="n">EXPRESSION_NODE_CALLBACKS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ExpressionNode</span><span class="o">.</span><span class="n">ADD</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span>
    <span class="n">ExpressionNode</span><span class="o">.</span><span class="n">SUB</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span>
    <span class="n">ExpressionNode</span><span class="o">.</span><span class="n">MUL</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span>
    <span class="n">ExpressionNode</span><span class="o">.</span><span class="n">DIV</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">div</span><span class="p">,</span>
    <span class="n">ExpressionNode</span><span class="o">.</span><span class="n">MOD</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">mod</span><span class="p">,</span>
    <span class="n">ExpressionNode</span><span class="o">.</span><span class="n">AND</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">and_</span><span class="p">,</span>
    <span class="n">ExpressionNode</span><span class="o">.</span><span class="n">OR</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span>
    <span class="p">}</span>

<span class="k">class</span> <span class="nc">CannotResolve</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">_resolve</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ExpressionNode</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_resolve</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">node</span>

<span class="k">def</span> <span class="nf">resolve_expression_node</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">EXPRESSION_NODE_CALLBACKS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">connector</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CannotResolve</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="n">_resolve</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">_resolve</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">runner</span>

<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">full_clean</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="s2">&quot;Atomically update instance, setting field/value pairs from kwargs&quot;</span>

    <span class="c1"># apply the updated args to the instance to mimic the change</span>
    <span class="c1"># note that these might slightly differ from the true database values</span>
    <span class="c1"># as the DB could have been updated by another thread. callers should</span>
    <span class="c1"># retrieve a new copy of the object if up-to-date values are required</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ExpressionNode</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">resolve_expression_node</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="c1"># clean instance before update</span>
    <span class="k">if</span> <span class="n">full_clean</span><span class="p">:</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">full_clean</span><span class="p">()</span>

    <span class="c1"># fields that use auto_now=True should be updated corrected, too!</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;auto_now&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">auto_now</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">pre_save</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="n">rows_affected</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rows_affected</span>

<span class="c1">#**</span>
</pre></div>
<p>Теперь мы можем делать так:</p>
<div class="highlight"><pre><span></span><span class="c1"># Обновили объект и сохранили его в базу, через</span>
<span class="n">update</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">custom_field</span><span class="o">=</span><span class="n">custom_value</span><span class="p">)</span>

<span class="k">print</span> <span class="n">order</span><span class="o">.</span><span class="n">custom_field</span>
<span class="c1"># Output: custom_value</span>
</pre></div>
<p>Или даже так:</p>
<div class="highlight"><pre><span></span><span class="n">update</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">custom_field</span><span class="o">=</span><span class="n">custom_value</span><span class="p">,</span> <span class="n">other_field</span><span class="o">=</span><span class="n">other_value</span><span class="p">,</span> <span class="n">more_field</span><span class="o">=</span><span class="n">more_value</span><span class="p">)</span>
</pre></div>
<p>Обходясь при этом без тяжелых запросов к базе.</p>
<pre class="literal-block">
SELECT (1) AS &quot;a&quot; FROM &quot;main_order&quot; WHERE &quot;main_order&quot;.&quot;id&quot; = 22387  LIMIT 1; args=(22387,)
UPDATE &quot;main_order&quot; SET &quot;created_at&quot; = E'2011-12-02 19:39:00.969044', &quot;city_id&quot; = 1, &quot;when&quot; = E'2011-12-02 19:50:00', &quot;price&quot; = E'100.00', &quot;expected_price&quot; = E'350.00', &quot;car_class&quot; = 10, &quot;conditioner&quot; = false, &quot;smoke&quot; = false, &quot;no_smoke&quot; = false, &quot;child_seat&quot; = false, &quot;long_length&quot; = false, &quot;meet_sign&quot; = false, &quot;from_address_id&quot; = 17130, &quot;to_address_id&quot; = 17131, &quot;route_id&quot; = NULL, &quot;from_node_id&quot; = 501, &quot;to_node_id&quot; = 501, &quot;from_address_entrance_no&quot; = E'', &quot;from_comment&quot; = E'', &quot;to_comment&quot; = E'', &quot;flight_number&quot; = E'', &quot;meet_sign_text&quot; = E'', &quot;auto_id&quot; = NULL, &quot;fare_id&quot; = 42, &quot;taxistation_id&quot; = 1, &quot;passenger_id&quot; = 71111111111, &quot;device_id&quot; = E'200774696189910', &quot;device_agent&quot; = E'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/535.2 ', &quot;device_name&quot; = E'Web', &quot;device_token&quot; = E'', &quot;device_sms&quot; = true, &quot;current_status&quot; = E'WaitForCarAssigment', &quot;updated&quot; = E'2011-12-02 19:40:09.405462', &quot;credit&quot; = false WHERE &quot;main_order&quot;.&quot;id&quot; = 22387 ; args=(u'2011-12-02 19:39:00.969044', 1, u'2011-12-02 19:50:00', u'100.00', u'350.00', 10, False, False, False, False, False, False, 17130, 17131, 501, 501, u'', u'', u'', u'', u'', 42, 1, 71111111111L, u'200774696189910', u'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/535.2 ', u'Web', u'', True, 'WaitForCarAssigment', u'2011-12-02 19:40:09.405462', False, 22387)
</pre>
<p>VS</p>
<pre class="literal-block">
UPDATE &quot;main_order&quot; SET &quot;price&quot; = E'100.00' WHERE &quot;main_order&quot;.&quot;id&quot; = 22387 ; args=(u'100.00', 22387)
</pre>
<p>Надеюсь эти несколько простых функций, будут также полезны вам, как и мне.</p>
</div>

        </div>


<g:plusone></g:plusone>
<script>(function(d, t) {
    var g = d.createElement(t),
        s = d.getElementsByTagName(t)[0];
    g.async = true;
    g.src = 'https://apis.google.com/js/plusone.js';
    g.text = '{lang:"nl"}';
    s.parentNode.insertBefore(g, s);
}(document, 'script'));
</script>
<div class="article_paginator zeta">        <div class="article_paginator_right">
            <a href="https-setup.html" class="article_paginator_right_link">Настройка HTTPS для чайников</a> Ctrl→
        </div>        <div class="article_paginator_left">
            ←Ctrl <a href="deploy-setup.html" class="article_paginator_left_link">Настройка сервера. Создаем и разворачиваем django-проект</a>
        </div></div>
    </article>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'klengithubcom';
        var disqus_identifier = 'django-snippets';
        var disqus_url = 'http://klen.github.io/django-snippets.html';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 

<div class="share">
    <div class="addthis_toolbox addthis_default_style ">
    <a class="addthis_button_preferred_1"></a>
    <a class="addthis_button_preferred_2"></a>
    <a class="addthis_button_preferred_3"></a>
    <a class="addthis_button_preferred_4"></a>
    <a class="addthis_button_compact"></a>
    <a class="addthis_counter addthis_bubble_style"></a>
    </div>
    <script type="text/javascript">var addthis_config = {"data_track_clickback":true};</script>
    <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-4e108f9f24976375"></script>
</div>        </div>

    <a class="github" href="http://github.com/klen"><img src="./static/ForkMe_Wht.png" alt="alt"/></a>    <footer class="footer">
        © 2011–2015 Kirill Klenov
&nbsp;&nbsp;|&nbsp;&nbsp;            <a href="./pages/about-en.html">About me</a>
        <div class='pos1'></div>
        <div class='pos2'></div>
    </footer>

    <script language="javascript" type="text/javascript" src="./theme/build_main.js"></script><div style="display:none;"><script type="text/javascript">
(function(w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
        w.yaCounter7784947 = new Ya.Metrika({
            id:7784947,
            enableAll:true, webvisor:true});
        } catch(e) {}
    });
})(window, 'yandex_metrika_callbacks');
</script></div>
<script src="//mc.yandex.ru/metrika/watch.js" type="text/javascript" defer="defer"></script>
<noscript><div><img src="//mc.yandex.ru/watch/7784947" style="position:absolute; left:-9999px;" alt="" /></div></noscript><script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30512655-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>